<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Garden Journal</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4a7c59">

<!-- Apple PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Garden">
<link rel="apple-touch-icon" href="icons/icon-192.svg">

<!-- Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green-dark: #3a6349;
  --green: #4a7c59;
  --green-light: #6a9b78;
  --green-pale: #e8f0ea;
  --brown: #8b6f47;
  --brown-light: #a8896a;
  --cream: #faf6f0;
  --cream-dark: #f0e8da;
  --text: #2c2c2c;
  --text-light: #6b6b6b;
  --white: #ffffff;
  --red: #c25050;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
  --radius: 12px;
  --nav-height: 64px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

body {
  font-family: 'Nunito', sans-serif;
  background: var(--cream);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* Header */
.header {
  background: var(--green);
  color: var(--white);
  padding: 16px 20px;
  padding-top: calc(env(safe-area-inset-top, 16px) + 8px);
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}
.header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: 0.3px; }
.header-sub { font-size: 0.75rem; opacity: 0.8; margin-top: 2px; }

/* Pages */
.page {
  display: none;
  padding: 16px;
  padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 24px);
  max-width: 600px;
  margin: 0 auto;
}
.page.active { display: block; }

/* Bottom Nav */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--white);
  display: flex;
  justify-content: space-around;
  align-items: center;
  height: calc(var(--nav-height) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
  z-index: 100;
}
.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: none;
  border: none;
  color: var(--text-light);
  font-family: inherit;
  font-size: 0.65rem;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 6px;
  border-radius: 8px;
  transition: color 0.2s;
}
.nav-btn .nav-icon { font-size: 1.4rem; }
.nav-btn.active { color: var(--green); }

/* Cards */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

/* Entry cards */
.entry-card { cursor: pointer; transition: transform 0.15s; }
.entry-card:active { transform: scale(0.98); }
.entry-date { font-size: 0.75rem; color: var(--text-light); margin-bottom: 6px; }
.entry-text {
  font-size: 0.95rem;
  line-height: 1.5;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.entry-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

/* Badges / Tags */
.badge {
  display: inline-block;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 20px;
  background: var(--green-pale);
  color: var(--green-dark);
}
.badge.cat { background: var(--green); color: var(--white); }
.tag {
  font-size: 0.7rem;
  color: var(--brown);
  background: var(--cream-dark);
  padding: 2px 8px;
  border-radius: 10px;
}

/* Category selector */
.cat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}
.cat-btn {
  padding: 10px 8px;
  border: 2px solid var(--cream-dark);
  border-radius: var(--radius);
  background: var(--white);
  font-family: inherit;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.cat-btn .cat-icon { display: block; font-size: 1.3rem; margin-bottom: 4px; }
.cat-btn.selected {
  border-color: var(--green);
  background: var(--green-pale);
  color: var(--green-dark);
}

/* Form elements */
.input-group { margin-bottom: 16px; }
.input-group label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 6px;
}
textarea, input[type="text"], input[type="date"], input[type="password"] {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid var(--cream-dark);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 1rem;
  background: var(--white);
  color: var(--text);
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
textarea:focus, input:focus { outline: none; border-color: var(--green-light); }
textarea { min-height: 120px; resize: vertical; line-height: 1.5; }

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 24px;
  border: none;
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--green); color: var(--white); width: 100%; }
.btn-primary:hover { background: var(--green-dark); }
.btn-secondary { background: var(--cream-dark); color: var(--text); width: 100%; }
.btn-danger { background: var(--red); color: var(--white); }
.btn-small { padding: 8px 16px; font-size: 0.85rem; width: auto; }

/* Mic button */
.mic-btn {
  background: var(--green);
  color: var(--white);
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.mic-btn.listening {
  background: var(--red);
  animation: pulse 1.2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(194, 80, 80, 0.4); }
  50% { box-shadow: 0 0 0 12px rgba(194, 80, 80, 0); }
}
.mic-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.mic-hint { font-size: 0.75rem; color: var(--text-light); margin-bottom: 16px; }

/* Filter bar */
.filter-bar {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 8px;
  margin-bottom: 12px;
  -webkit-overflow-scrolling: touch;
}
.filter-bar::-webkit-scrollbar { display: none; }
.filter-chip {
  flex-shrink: 0;
  padding: 6px 14px;
  border-radius: 20px;
  border: 2px solid var(--cream-dark);
  background: var(--white);
  font-family: inherit;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-light);
  cursor: pointer;
  white-space: nowrap;
}
.filter-chip.active {
  border-color: var(--green);
  background: var(--green);
  color: var(--white);
}

/* Search box */
.search-box { position: relative; margin-bottom: 12px; }
.search-box input { padding-left: 40px; }
.search-box .search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1rem;
  color: var(--text-light);
  pointer-events: none;
}
.date-range { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
.date-range input { flex: 1; font-size: 0.85rem; padding: 10px; }
.date-range span { color: var(--text-light); font-size: 0.85rem; }

/* Settings */
.settings-section { margin-bottom: 20px; }
.settings-section h3 {
  font-size: 0.9rem;
  color: var(--text-light);
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.settings-row { display: flex; gap: 10px; flex-wrap: wrap; }
.entry-count { text-align: center; color: var(--text-light); font-size: 0.85rem; padding: 20px; }
.entry-count strong { display: block; font-size: 2rem; color: var(--green); }

/* Empty state */
.empty-state { text-align: center; padding: 48px 20px; color: var(--text-light); }
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }
.empty-state p { font-size: 0.95rem; line-height: 1.5; }

/* Detail overlay */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: flex-end;
  justify-content: center;
}
.overlay.open { display: flex; }
.overlay-panel {
  background: var(--white);
  width: 100%;
  max-width: 600px;
  max-height: 85vh;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  padding-bottom: calc(20px + var(--safe-bottom));
  overflow-y: auto;
  animation: slideUp 0.25s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.overlay-handle {
  width: 36px;
  height: 4px;
  background: var(--cream-dark);
  border-radius: 2px;
  margin: 0 auto 16px;
}
.detail-date { font-size: 0.85rem; color: var(--text-light); margin-bottom: 12px; }
.detail-text { font-size: 1.05rem; line-height: 1.7; margin-bottom: 16px; }
.detail-actions { display: flex; gap: 10px; margin-top: 16px; }

/* Toast */
.toast {
  position: fixed;
  bottom: calc(var(--nav-height) + var(--safe-bottom) + 16px);
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--text);
  color: var(--white);
  padding: 12px 24px;
  border-radius: 30px;
  font-size: 0.85rem;
  font-weight: 600;
  z-index: 300;
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Confirm dialog */
.confirm-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 300;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.confirm-overlay.open { display: flex; }
.confirm-box {
  background: var(--white);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 320px;
  width: 100%;
  text-align: center;
}
.confirm-box p { margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5; }
.confirm-actions { display: flex; gap: 10px; }
.confirm-actions .btn { flex: 1; }

/* ===== CHAT (Ask) ===== */
.chat-container {
  display: flex;
  flex-direction: column;
  height: calc(100dvh - 120px - var(--nav-height) - var(--safe-bottom));
  min-height: 300px;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding-bottom: 12px;
  -webkit-overflow-scrolling: touch;
}
.chat-msg {
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
}
.chat-msg.user { align-items: flex-end; }
.chat-msg.assistant { align-items: flex-start; }
.chat-bubble {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 0.95rem;
  line-height: 1.5;
  word-wrap: break-word;
}
.chat-msg.user .chat-bubble {
  background: var(--green);
  color: var(--white);
  border-bottom-right-radius: 4px;
}
.chat-msg.assistant .chat-bubble {
  background: var(--white);
  color: var(--text);
  border-bottom-left-radius: 4px;
  box-shadow: var(--shadow);
}
.chat-bubble p { margin-bottom: 8px; }
.chat-bubble p:last-child { margin-bottom: 0; }
.chat-bubble ul, .chat-bubble ol { margin: 4px 0 8px 20px; }
.chat-bubble li { margin-bottom: 4px; }
.chat-bubble strong { font-weight: 700; }
.chat-bubble code {
  background: var(--cream-dark);
  padding: 1px 4px;
  border-radius: 4px;
  font-size: 0.85em;
}
.chat-input-row {
  display: flex;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--cream-dark);
}
.chat-input-row input {
  flex: 1;
  padding: 12px 14px;
}
.chat-send-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: var(--green);
  color: var(--white);
  font-size: 1.2rem;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.15s;
}
.chat-send-btn:disabled { background: var(--cream-dark); color: var(--text-light); }
.chat-send-btn:active { transform: scale(0.95); }
.chat-typing {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}
.chat-typing span {
  width: 8px;
  height: 8px;
  background: var(--text-light);
  border-radius: 50%;
  animation: typingDot 1.4s ease-in-out infinite;
}
.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingDot {
  0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
  30% { opacity: 1; transform: scale(1); }
}
.chat-suggestions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}
.chat-suggestion-btn {
  background: var(--white);
  border: 2px solid var(--cream-dark);
  border-radius: var(--radius);
  padding: 12px 16px;
  font-family: inherit;
  font-size: 0.9rem;
  color: var(--text);
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
}
.chat-suggestion-btn:active {
  border-color: var(--green);
  background: var(--green-pale);
}
.api-key-prompt {
  text-align: center;
  padding: 20px;
}
.api-key-prompt p {
  font-size: 0.9rem;
  line-height: 1.6;
  color: var(--text-light);
  margin-bottom: 16px;
}

/* ===== PLANTING CALENDAR ===== */
.month-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-bottom: 16px;
}
.month-nav-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid var(--cream-dark);
  background: var(--white);
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.month-nav-btn:active { background: var(--cream-dark); }
.month-nav h2 { font-size: 1.1rem; font-weight: 700; min-width: 160px; text-align: center; }
.month-nav .month-current {
  font-size: 0.7rem;
  background: var(--green);
  color: var(--white);
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 6px;
  vertical-align: middle;
}
.plan-section { margin-bottom: 16px; }
.plan-section-title {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.plan-section-title.start-indoors { color: #8b5cf6; }
.plan-section-title.direct-sow { color: var(--green-dark); }
.plan-section-title.transplant { color: #d97706; }
.plan-section-title.harvest { color: var(--red); }
.plan-section-title.tasks { color: var(--brown); }
.plan-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.plan-item {
  background: var(--white);
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 0.85rem;
  box-shadow: var(--shadow);
  border-left: 3px solid var(--cream-dark);
}
.plan-item.start-indoors { border-left-color: #8b5cf6; }
.plan-item.direct-sow { border-left-color: var(--green-dark); }
.plan-item.transplant { border-left-color: #d97706; }
.plan-item.harvest { border-left-color: var(--red); }
.plan-item.tasks { border-left-color: var(--brown); }
.plan-tip {
  background: var(--green-pale);
  border-radius: var(--radius);
  padding: 12px 16px;
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--green-dark);
  margin-top: 8px;
}
.plan-journal-entries { margin-top: 16px; }
.plan-journal-entries h4 {
  font-size: 0.8rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

/* Photo */
.photo-preview {
  position: relative;
  margin-bottom: 12px;
  border-radius: var(--radius);
  overflow: hidden;
  display: inline-block;
}
.photo-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: var(--radius);
  display: block;
}
.photo-preview .photo-remove {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.6);
  color: var(--white);
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.cam-btn {
  background: var(--brown);
  color: var(--white);
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}
.cam-btn:active { transform: scale(0.95); }
.chat-photo-preview {
  margin: 8px 0;
  max-width: 200px;
}
.chat-photo-preview img {
  width: 100%;
  border-radius: 8px;
}
.entry-thumb {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  margin-top: 8px;
}

.hidden { display: none; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Garden Journal</h1>
  <div class="header-sub">Zone 7b/8a &middot; Washington, DC</div>
</div>

<!-- ===== JOURNAL PAGE ===== -->
<div id="page-journal" class="page active">
  <div class="search-box">
    <span class="search-icon">&#x1F50D;</span>
    <input type="text" id="journalSearch" placeholder="Search observations...">
  </div>
  <div class="filter-bar" id="filterBar">
    <button class="filter-chip active" data-cat="all">All</button>
    <button class="filter-chip" data-cat="seedlings">Seedlings</button>
    <button class="filter-chip" data-cat="beds">Beds/Plots</button>
    <button class="filter-chip" data-cat="harvest">Harvest</button>
    <button class="filter-chip" data-cat="pests">Pests/Disease</button>
    <button class="filter-chip" data-cat="weather">Weather</button>
    <button class="filter-chip" data-cat="watering">Watering</button>
    <button class="filter-chip" data-cat="general">General</button>
  </div>
  <div id="journalEntries"></div>
</div>

<!-- ===== PLAN PAGE ===== -->
<div id="page-plan" class="page">
  <div class="month-nav">
    <button class="month-nav-btn" id="prevMonth">&#9664;</button>
    <h2 id="monthTitle"></h2>
    <button class="month-nav-btn" id="nextMonth">&#9654;</button>
  </div>
  <div id="planContent"></div>
  <div class="plan-journal-entries" id="planJournalEntries"></div>
</div>

<!-- ===== ADD PAGE ===== -->
<div id="page-add" class="page">
  <div class="card">
    <div class="input-group">
      <label>What did you observe?</label>
      <div class="mic-row">
        <textarea id="entryText" placeholder="Tap the mic or start typing..."></textarea>
        <button class="mic-btn" id="micBtn" title="Voice input">&#x1F3A4;</button>
      </div>
      <div class="mic-hint" id="micHint">Tap the microphone to dictate</div>
    </div>

    <div class="input-group">
      <label>Photo <span style="font-weight:400;color:var(--text-light)">(optional)</span></label>
      <button class="btn btn-secondary btn-small" id="addPhotoBtn" style="margin-bottom:8px">&#x1F4F7; Add Photo</button>
      <input type="file" id="addPhotoInput" accept="image/*" capture="environment" class="hidden">
      <div id="addPhotoPreview"></div>
    </div>

    <div class="input-group">
      <label>Category</label>
      <div class="cat-grid" id="catGrid">
        <button class="cat-btn" data-cat="seedlings"><span class="cat-icon">&#x1F331;</span>Seedlings</button>
        <button class="cat-btn" data-cat="beds"><span class="cat-icon">&#x1F33F;</span>Beds/Plots</button>
        <button class="cat-btn" data-cat="harvest"><span class="cat-icon">&#x1F345;</span>Harvest</button>
        <button class="cat-btn" data-cat="pests"><span class="cat-icon">&#x1F41B;</span>Pests</button>
        <button class="cat-btn" data-cat="weather"><span class="cat-icon">&#x1F324;</span>Weather</button>
        <button class="cat-btn" data-cat="watering"><span class="cat-icon">&#x1F4A7;</span>Watering</button>
        <button class="cat-btn selected" data-cat="general"><span class="cat-icon">&#x1F4DD;</span>General</button>
      </div>
    </div>

    <div class="input-group">
      <label>Tags <span style="font-weight:400;color:var(--text-light)">(comma separated, optional)</span></label>
      <input type="text" id="entryTags" placeholder="e.g. tomato, indoor, raised bed">
    </div>

    <button class="btn btn-primary" id="saveBtn">Save Observation</button>
  </div>
</div>

<!-- ===== ASK PAGE ===== -->
<div id="page-ask" class="page">
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-msg assistant">
        <div class="chat-bubble">
          <p>Hi! I'm your garden assistant. I know about your <strong>1,200 sq ft Zone 7b/8a garden in DC</strong>, and I can see all your journal entries.</p>
          <p>Ask me anything about what to plant, pest identification, timing, or your garden history.</p>
        </div>
      </div>
      <div class="chat-suggestions" id="chatSuggestions">
        <button class="chat-suggestion-btn" data-q="What should I be doing in my garden this week?">What should I be doing in my garden this week?</button>
        <button class="chat-suggestion-btn" data-q="What are the best vegetables for Zone 7b/8a beginners?">What are the best vegetables for Zone 7b/8a beginners?</button>
        <button class="chat-suggestion-btn" data-q="When should I start tomato seeds indoors?">When should I start tomato seeds indoors?</button>
      </div>
    </div>
    <div id="apiKeyPrompt" class="api-key-prompt hidden">
      <p>To chat with your garden assistant, enter your <strong>Anthropic API key</strong>. It's stored only on this device.</p>
      <div class="input-group">
        <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
      </div>
      <button class="btn btn-primary" id="saveApiKey">Save Key</button>
      <p style="margin-top:12px;font-size:0.75rem">Get a key at <strong>console.anthropic.com</strong></p>
    </div>
    <div id="chatPhotoPreview"></div>
    <div class="chat-input-row" id="chatInputRow">
      <button class="cam-btn" id="chatCamBtn" title="Send a photo">&#x1F4F7;</button>
      <input type="file" id="chatPhotoInput" accept="image/*" capture="environment" class="hidden">
      <input type="text" id="chatInput" placeholder="Ask about your garden...">
      <button class="chat-send-btn" id="chatSend">&#x27A4;</button>
    </div>
  </div>
</div>

<!-- ===== SETTINGS PAGE ===== -->
<div id="page-settings" class="page">
  <div class="card">
    <div id="entryCountDisplay" class="entry-count"></div>
  </div>

  <div class="settings-section">
    <h3>Claude API Key</h3>
    <div class="input-group" style="margin-bottom:8px">
      <input type="password" id="settingsApiKey" placeholder="sk-ant-...">
    </div>
    <div class="settings-row">
      <button class="btn btn-secondary btn-small" id="settingsSaveKey">Save Key</button>
      <button class="btn btn-secondary btn-small" id="settingsClearKey">Remove Key</button>
    </div>
  </div>

  <div class="settings-section">
    <h3>Data Management</h3>
    <div class="settings-row">
      <button class="btn btn-secondary btn-small" id="exportBtn">Export JSON</button>
      <button class="btn btn-secondary btn-small" id="importBtn">Import JSON</button>
    </div>
    <input type="file" id="importFile" accept=".json" class="hidden">
  </div>

  <div class="settings-section">
    <h3>Backup</h3>
    <div class="settings-row">
      <button class="btn btn-secondary btn-small" id="emailBtn">Email Backup</button>
    </div>
  </div>

  <div class="settings-section">
    <h3>Danger Zone</h3>
    <div class="settings-row">
      <button class="btn btn-danger btn-small" id="clearBtn">Delete All Data</button>
    </div>
  </div>
</div>

<!-- ===== DETAIL OVERLAY ===== -->
<div class="overlay" id="detailOverlay">
  <div class="overlay-panel">
    <div class="overlay-handle"></div>
    <div class="detail-date" id="detailDate"></div>
    <div class="entry-meta" id="detailMeta" style="margin-bottom:12px"></div>
    <div class="detail-text" id="detailText"></div>
    <div class="detail-actions">
      <button class="btn btn-secondary btn-small" id="detailEditBtn">Edit</button>
      <button class="btn btn-danger btn-small" id="detailDeleteBtn">Delete</button>
      <button class="btn btn-secondary btn-small" style="margin-left:auto" id="detailCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- ===== CONFIRM DIALOG ===== -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p id="confirmMsg"></p>
    <div class="confirm-actions">
      <button class="btn btn-secondary btn-small" id="confirmNo">Cancel</button>
      <button class="btn btn-danger btn-small" id="confirmYes">Delete</button>
    </div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"></div>

<!-- ===== BOTTOM NAV ===== -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-page="journal">
    <span class="nav-icon">&#x1F4D6;</span>Journal
  </button>
  <button class="nav-btn" data-page="plan">
    <span class="nav-icon">&#x1F4C5;</span>Plan
  </button>
  <button class="nav-btn" data-page="add">
    <span class="nav-icon">&#x2795;</span>Add
  </button>
  <button class="nav-btn" data-page="ask">
    <span class="nav-icon">&#x1F33B;</span>Ask
  </button>
  <button class="nav-btn" data-page="settings">
    <span class="nav-icon">&#x2699;</span>More
  </button>
</nav>

<script>
// ===================== DATA LAYER =====================
const STORAGE_KEY = 'garden-journal-entries';
const API_KEY_KEY = 'garden-journal-api-key';
const CATEGORIES = {
  seedlings: { label: 'Seedlings', icon: '\u{1F331}' },
  beds:      { label: 'Beds/Plots', icon: '\u{1F33F}' },
  harvest:   { label: 'Harvest', icon: '\u{1F345}' },
  pests:     { label: 'Pests/Disease', icon: '\u{1F41B}' },
  weather:   { label: 'Weather', icon: '\u{1F324}\uFE0F' },
  watering:  { label: 'Watering', icon: '\u{1F4A7}' },
  general:   { label: 'General', icon: '\u{1F4DD}' }
};

function loadEntries() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}
function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
function generateId() { return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8); }
function getApiKey() { return localStorage.getItem(API_KEY_KEY) || ''; }
function setApiKey(k) { localStorage.setItem(API_KEY_KEY, k); }
function clearApiKey() { localStorage.removeItem(API_KEY_KEY); }

// ===================== NAVIGATION =====================
const pages = document.querySelectorAll('.page');
const navBtns = document.querySelectorAll('.nav-btn');

function navigate(pageName) {
  pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + pageName));
  navBtns.forEach(b => b.classList.toggle('active', b.dataset.page === pageName));
  if (pageName === 'journal') renderJournal();
  if (pageName === 'settings') renderSettings();
  if (pageName === 'plan') renderPlan();
  if (pageName === 'ask') initChat();
  window.scrollTo(0, 0);
}
navBtns.forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.page)));

// ===================== TOAST / CONFIRM =====================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

let confirmCallback = null;
function showConfirm(msg, cb) {
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmOverlay').classList.add('open');
  confirmCallback = cb;
}
document.getElementById('confirmNo').addEventListener('click', () => {
  document.getElementById('confirmOverlay').classList.remove('open');
  confirmCallback = null;
});
document.getElementById('confirmYes').addEventListener('click', () => {
  document.getElementById('confirmOverlay').classList.remove('open');
  if (confirmCallback) confirmCallback();
  confirmCallback = null;
});

// ===================== FORMAT HELPERS =====================
function formatDate(iso) {
  const d = new Date(iso);
  const diffDays = Math.floor((new Date() - d) / 86400000);
  if (diffDays === 0) return 'Today at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  if (diffDays === 1) return 'Yesterday at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  if (diffDays < 7) return d.toLocaleDateString('en-US', { weekday: 'long' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function formatDateLong(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) +
    ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===================== RENDER ENTRIES =====================
function renderEntryCards(entries, container) {
  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">\u{1F33B}</div><p>No observations found.</p></div>';
    return;
  }
  container.innerHTML = entries.map(e => {
    const cat = CATEGORIES[e.category] || CATEGORIES.general;
    const tagsHtml = (e.tags || []).filter(t => t).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
    const photoHtml = e.photo ? `<img class="entry-thumb" src="${e.photo}" alt="photo">` : '';
    return `<div class="card entry-card" data-id="${e.id}">
      <div class="entry-date">${formatDate(e.date)}</div>
      <div class="entry-text">${escapeHtml(e.text)}</div>
      <div class="entry-meta"><span class="badge cat">${cat.icon} ${cat.label}</span>${tagsHtml}</div>
      ${photoHtml}
    </div>`;
  }).join('');
  container.querySelectorAll('.entry-card').forEach(card => {
    card.addEventListener('click', () => openDetail(card.dataset.id));
  });
}

// ===================== JOURNAL PAGE (with search) =====================
let journalFilter = 'all';

function renderJournal() {
  const query = document.getElementById('journalSearch').value.trim().toLowerCase();
  let entries = loadEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
  if (journalFilter !== 'all') entries = entries.filter(e => e.category === journalFilter);
  if (query) entries = entries.filter(e =>
    e.text.toLowerCase().includes(query) ||
    (e.tags || []).some(t => t.toLowerCase().includes(query))
  );
  renderEntryCards(entries, document.getElementById('journalEntries'));
}

document.getElementById('journalSearch').addEventListener('input', renderJournal);
document.getElementById('filterBar').addEventListener('click', e => {
  const chip = e.target.closest('.filter-chip');
  if (!chip) return;
  document.querySelectorAll('#filterBar .filter-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  journalFilter = chip.dataset.cat;
  renderJournal();
});

// ===================== ADD PAGE =====================
let selectedCategory = 'general';

document.getElementById('catGrid').addEventListener('click', e => {
  const btn = e.target.closest('.cat-btn');
  if (!btn) return;
  document.querySelectorAll('#catGrid .cat-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedCategory = btn.dataset.cat;
});

document.getElementById('saveBtn').addEventListener('click', () => {
  const text = document.getElementById('entryText').value.trim();
  if (!text) { showToast('Please enter an observation'); return; }
  const tags = document.getElementById('entryTags').value.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
  const entry = { id: generateId(), date: new Date().toISOString(), text, category: selectedCategory, tags, photo: addPhotoData || null };
  const entries = loadEntries();
  entries.push(entry);
  saveEntries(entries);
  document.getElementById('entryText').value = '';
  document.getElementById('entryTags').value = '';
  addPhotoData = null;
  document.getElementById('addPhotoPreview').innerHTML = '';
  selectedCategory = 'general';
  document.querySelectorAll('#catGrid .cat-btn').forEach(b => b.classList.toggle('selected', b.dataset.cat === 'general'));
  showToast('Observation saved!');
  navigate('journal');
});

// ===================== VOICE INPUT =====================
const micBtn = document.getElementById('micBtn');
const micHint = document.getElementById('micHint');
const entryTextEl = document.getElementById('entryText');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null, isListening = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  let finalTranscript = '';
  recognition.onresult = (e) => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const existing = entryTextEl.value.slice(0, entryTextEl.value.length - (entryTextEl.dataset.interim || '').length);
    entryTextEl.value = existing + finalTranscript + interim;
    entryTextEl.dataset.interim = interim;
  };
  recognition.onend = () => {
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = '\u{1F3A4}';
    micHint.textContent = 'Tap the microphone to dictate';
    entryTextEl.dataset.interim = '';
    finalTranscript = '';
  };
  recognition.onerror = () => {
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = '\u{1F3A4}';
    micHint.textContent = 'Tap the microphone to dictate';
    finalTranscript = '';
  };
  micBtn.addEventListener('click', () => {
    if (isListening) { recognition.stop(); }
    else {
      finalTranscript = '';
      entryTextEl.dataset.interim = '';
      recognition.start();
      isListening = true;
      micBtn.classList.add('listening');
      micBtn.textContent = '\u23F9';
      micHint.textContent = 'Listening... tap to stop';
    }
  });
} else {
  micBtn.addEventListener('click', () => {
    entryTextEl.focus();
    micHint.innerHTML = 'Tap the <strong>\u{1F3A4} on your keyboard</strong> to dictate';
  });
  micHint.innerHTML = 'Use the <strong>\u{1F3A4} on your keyboard</strong> to dictate';
}

// ===================== PHOTO HANDLING =====================
let addPhotoData = null; // base64 jpeg for add page
let chatPhotoData = null; // base64 jpeg for chat

function compressImage(file, maxWidth, quality) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// Add page photo
document.getElementById('addPhotoBtn').addEventListener('click', () => {
  document.getElementById('addPhotoInput').click();
});
document.getElementById('addPhotoInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  addPhotoData = await compressImage(file, 800, 0.7);
  document.getElementById('addPhotoPreview').innerHTML =
    `<div class="photo-preview"><img src="${addPhotoData}"><button class="photo-remove" id="removeAddPhoto">\u2715</button></div>`;
  document.getElementById('removeAddPhoto').addEventListener('click', () => {
    addPhotoData = null;
    document.getElementById('addPhotoPreview').innerHTML = '';
  });
  e.target.value = '';
});

// Chat page photo
document.getElementById('chatCamBtn').addEventListener('click', () => {
  document.getElementById('chatPhotoInput').click();
});
document.getElementById('chatPhotoInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  chatPhotoData = await compressImage(file, 1024, 0.8);
  document.getElementById('chatPhotoPreview').innerHTML =
    `<div class="photo-preview"><img src="${chatPhotoData}"><button class="photo-remove" id="removeChatPhoto">\u2715</button></div>`;
  document.getElementById('removeChatPhoto').addEventListener('click', () => {
    chatPhotoData = null;
    document.getElementById('chatPhotoPreview').innerHTML = '';
  });
  if (!document.getElementById('chatInput').value.trim()) {
    document.getElementById('chatInput').value = "What's going on with this plant?";
  }
  e.target.value = '';
});

// ===================== DETAIL OVERLAY =====================
let currentDetailId = null;

function openDetail(id) {
  const entry = loadEntries().find(e => e.id === id);
  if (!entry) return;
  currentDetailId = id;
  const cat = CATEGORIES[entry.category] || CATEGORIES.general;
  document.getElementById('detailDate').textContent = formatDateLong(entry.date);
  document.getElementById('detailText').innerHTML = escapeHtml(entry.text) +
    (entry.photo ? `<div style="margin-top:12px"><img src="${entry.photo}" style="max-width:100%;border-radius:8px"></div>` : '');
  document.getElementById('detailMeta').innerHTML =
    `<span class="badge cat">${cat.icon} ${cat.label}</span>` +
    (entry.tags || []).filter(t => t).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
  document.getElementById('detailOverlay').classList.add('open');
}

document.getElementById('detailCloseBtn').addEventListener('click', () => {
  document.getElementById('detailOverlay').classList.remove('open');
  currentDetailId = null;
});
document.getElementById('detailOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('detailOverlay')) {
    document.getElementById('detailOverlay').classList.remove('open');
    currentDetailId = null;
  }
});
document.getElementById('detailDeleteBtn').addEventListener('click', () => {
  showConfirm('Delete this observation? This cannot be undone.', () => {
    saveEntries(loadEntries().filter(e => e.id !== currentDetailId));
    document.getElementById('detailOverlay').classList.remove('open');
    currentDetailId = null;
    renderJournal();
    showToast('Observation deleted');
  });
});
document.getElementById('detailEditBtn').addEventListener('click', () => {
  const entry = loadEntries().find(e => e.id === currentDetailId);
  if (!entry) return;
  document.getElementById('detailOverlay').classList.remove('open');
  document.getElementById('entryText').value = entry.text;
  document.getElementById('entryTags').value = (entry.tags || []).join(', ');
  selectedCategory = entry.category;
  document.querySelectorAll('#catGrid .cat-btn').forEach(b => b.classList.toggle('selected', b.dataset.cat === entry.category));
  saveEntries(loadEntries().filter(e => e.id !== currentDetailId));
  currentDetailId = null;
  navigate('add');
  showToast('Editing \u2014 save when done');
});

// ===================== PLANTING CALENDAR =====================
const PLANTING_DATA = {
  0: { // January
    name: 'January',
    indoors: ['Onions', 'Leeks'],
    sow: [],
    transplant: [],
    harvest: ['Kale (overwintered)', 'Winter lettuce (cold frame)'],
    tasks: ['Order seeds and plan garden layout', 'Review last year\u2019s journal notes', 'Clean and sharpen tools', 'Start a seed inventory']
  },
  1: { // February
    name: 'February',
    indoors: ['Peppers', 'Eggplant', 'Broccoli', 'Cauliflower', 'Cabbage', 'Celery'],
    sow: [],
    transplant: [],
    harvest: [],
    tasks: ['Set up seed starting station with grow lights', 'Prune fruit trees and grape vines', 'Amend beds with compost if soil is workable', 'Test soil pH and nutrients']
  },
  2: { // March
    name: 'March',
    indoors: ['Tomatoes', 'Basil', 'Herbs (parsley, cilantro)'],
    sow: ['Peas', 'Spinach', 'Lettuce', 'Radishes', 'Carrots', 'Arugula', 'Kale'],
    transplant: [],
    harvest: [],
    tasks: ['Direct sow cool-season crops mid-month', 'Prepare raised beds and amend soil', 'Set up trellises for peas', 'Start hardening off early seedlings']
  },
  3: { // April
    name: 'April',
    indoors: ['Squash', 'Cucumbers', 'Melons', 'Pumpkins'],
    sow: ['Beets', 'Swiss chard', 'Potatoes', 'Turnips', 'More lettuce/radish successions'],
    transplant: ['Broccoli', 'Cauliflower', 'Cabbage', 'Kale'],
    harvest: ['Radishes', 'Lettuce (early sown)'],
    tasks: ['Last frost is typically mid-April for DC', 'Set up drip irrigation or soaker hoses', 'Mulch around transplants', 'Watch for aphids on brassicas']
  },
  4: { // May
    name: 'May',
    indoors: [],
    sow: ['Beans (bush & pole)', 'Corn', 'Summer squash', 'Cucumbers', 'Okra', 'Sunflowers'],
    transplant: ['Tomatoes', 'Peppers', 'Eggplant', 'Basil', 'Squash', 'Cucumbers'],
    harvest: ['Peas', 'Spinach', 'Radishes', 'Lettuce', 'Strawberries (late May)'],
    tasks: ['Transplant warm-season crops after last frost', 'Stake or cage tomatoes at planting', 'Succession plant beans every 2-3 weeks', 'Set up pest monitoring (check for flea beetles)']
  },
  5: { // June
    name: 'June',
    indoors: [],
    sow: ['Beans (succession)', 'Summer squash (succession)', 'Basil'],
    transplant: [],
    harvest: ['Strawberries', 'Peas', 'Lettuce', 'Radishes', 'Garlic scapes', 'Herbs'],
    tasks: ['Mulch heavily to retain moisture in summer heat', 'Water deeply and consistently (1-2\u2033/week)', 'Remove spent cool-season crops', 'Scout for squash vine borers and tomato hornworms']
  },
  6: { // July
    name: 'July',
    indoors: ['Broccoli (fall crop)', 'Cabbage (fall crop)', 'Cauliflower (fall crop)'],
    sow: ['Beans (succession)', 'Carrots (fall)', 'Beets (fall)'],
    transplant: [],
    harvest: ['Tomatoes', 'Cucumbers', 'Squash', 'Beans', 'Peppers', 'Herbs', 'Garlic', 'Blueberries'],
    tasks: ['Start fall brassica seeds indoors mid-July', 'Keep up with harvesting to encourage production', 'Water early morning to reduce disease', 'Side-dress heavy feeders with compost or fertilizer']
  },
  7: { // August
    name: 'August',
    indoors: [],
    sow: ['Lettuce', 'Spinach', 'Radishes', 'Turnips', 'Kale', 'Arugula', 'Cilantro', 'Peas (late Aug)'],
    transplant: ['Broccoli (fall)', 'Cabbage (fall)', 'Cauliflower (fall)'],
    harvest: ['Tomatoes (peak)', 'Peppers', 'Eggplant', 'Corn', 'Cucumbers', 'Melons', 'Beans', 'Okra'],
    tasks: ['Direct sow fall crops starting mid-August', 'Begin preserving: canning, freezing, drying', 'Water fall transplants well to establish', 'Watch for late blight on tomatoes']
  },
  8: { // September
    name: 'September',
    indoors: [],
    sow: ['Garlic (late Sept)', 'Cover crops (crimson clover, winter rye)', 'Lettuce', 'Spinach'],
    transplant: [],
    harvest: ['Tomatoes', 'Peppers', 'Eggplant', 'Winter squash', 'Sweet potatoes', 'Apples', 'Fall beans'],
    tasks: ['Plant garlic cloves in late September', 'Sow cover crops on empty beds', 'First frost is typically late October for DC', 'Save seeds from best performers']
  },
  9: { // October
    name: 'October',
    indoors: [],
    sow: ['Garlic', 'Cover crops'],
    transplant: [],
    harvest: ['Fall lettuce', 'Kale', 'Broccoli', 'Carrots', 'Beets', 'Turnips', 'Winter squash', 'Pumpkins'],
    tasks: ['Harvest remaining warm-season crops before frost', 'Clean up spent plants and compost healthy material', 'Plant garlic if not done in September', 'Set up cold frames for winter greens']
  },
  10: { // November
    name: 'November',
    indoors: [],
    sow: [],
    transplant: [],
    harvest: ['Kale', 'Collards', 'Brussels sprouts (after frost)', 'Winter lettuce (cold frame)', 'Root vegetables'],
    tasks: ['Mulch perennial beds and garlic', 'Add leaves to compost pile', 'Drain and store hoses before hard freeze', 'Review journal and note what worked this year']
  },
  11: { // December
    name: 'December',
    indoors: [],
    sow: [],
    transplant: [],
    harvest: ['Kale (cold-hardy)', 'Cold frame greens'],
    tasks: ['Plan next year\u2019s garden layout', 'Browse seed catalogs and order early', 'Maintain compost pile', 'Clean and organize seed collection', 'Rest and enjoy the off-season!']
  }
};

let planMonth = new Date().getMonth();

function renderPlan() {
  const now = new Date();
  const data = PLANTING_DATA[planMonth];
  const isCurrentMonth = planMonth === now.getMonth();

  document.getElementById('monthTitle').innerHTML = data.name +
    (isCurrentMonth ? ' <span class="month-current">NOW</span>' : '');

  let html = '';

  if (data.indoors.length) {
    html += `<div class="plan-section">
      <div class="plan-section-title start-indoors">\u{1F3E0} Start Indoors</div>
      <div class="plan-items">${data.indoors.map(i => `<div class="plan-item start-indoors">${i}</div>`).join('')}</div>
    </div>`;
  }
  if (data.sow.length) {
    html += `<div class="plan-section">
      <div class="plan-section-title direct-sow">\u{1F331} Direct Sow</div>
      <div class="plan-items">${data.sow.map(i => `<div class="plan-item direct-sow">${i}</div>`).join('')}</div>
    </div>`;
  }
  if (data.transplant.length) {
    html += `<div class="plan-section">
      <div class="plan-section-title transplant">\u{1F33F} Transplant</div>
      <div class="plan-items">${data.transplant.map(i => `<div class="plan-item transplant">${i}</div>`).join('')}</div>
    </div>`;
  }
  if (data.harvest.length) {
    html += `<div class="plan-section">
      <div class="plan-section-title harvest">\u{1F345} Harvest</div>
      <div class="plan-items">${data.harvest.map(i => `<div class="plan-item harvest">${i}</div>`).join('')}</div>
    </div>`;
  }
  if (data.tasks.length) {
    html += `<div class="plan-section">
      <div class="plan-section-title tasks">\u2705 Tasks</div>
      <div class="plan-items">${data.tasks.map(i => `<div class="plan-item tasks">${i}</div>`).join('')}</div>
    </div>`;
  }

  document.getElementById('planContent').innerHTML = html;

  // Show journal entries from this month
  const entries = loadEntries()
    .filter(e => {
      const d = new Date(e.date);
      return d.getMonth() === planMonth;
    })
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 5);

  const jEl = document.getElementById('planJournalEntries');
  if (entries.length) {
    jEl.innerHTML = `<h4>Your ${data.name} Observations</h4>`;
    renderEntryCards(entries, jEl);
  } else {
    jEl.innerHTML = `<h4>Your ${data.name} Observations</h4>
      <div class="empty-state" style="padding:20px"><p>No observations for ${data.name} yet.</p></div>`;
  }
}

document.getElementById('prevMonth').addEventListener('click', () => {
  planMonth = (planMonth - 1 + 12) % 12;
  renderPlan();
});
document.getElementById('nextMonth').addEventListener('click', () => {
  planMonth = (planMonth + 1) % 12;
  renderPlan();
});

// ===================== ASK (Claude Chat) =====================
let chatHistory = []; // {role, content} pairs for API

function initChat() {
  const hasKey = !!getApiKey();
  document.getElementById('apiKeyPrompt').classList.toggle('hidden', hasKey);
  document.getElementById('chatInputRow').classList.toggle('hidden', !hasKey);
  if (!hasKey) {
    document.getElementById('chatMessages').style.display = 'none';
  } else {
    document.getElementById('chatMessages').style.display = '';
  }
}

document.getElementById('saveApiKey').addEventListener('click', () => {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { showToast('Please enter an API key'); return; }
  setApiKey(key);
  initChat();
  showToast('API key saved!');
});

// Suggestion buttons
document.getElementById('chatSuggestions').addEventListener('click', e => {
  const btn = e.target.closest('.chat-suggestion-btn');
  if (!btn) return;
  document.getElementById('chatInput').value = btn.dataset.q;
  sendChat();
});

document.getElementById('chatSend').addEventListener('click', sendChat);
document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

function buildSystemPrompt() {
  const entries = loadEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const monthData = PLANTING_DATA[new Date().getMonth()];

  let entrySummary = '';
  if (entries.length > 0) {
    const recent = entries.slice(0, 30);
    entrySummary = '\n\nRecent garden journal entries (newest first):\n' +
      recent.map(e => {
        const cat = (CATEGORIES[e.category] || CATEGORIES.general).label;
        const tags = (e.tags || []).join(', ');
        return `[${new Date(e.date).toLocaleDateString()}] (${cat}${tags ? ', tags: ' + tags : ''}) ${e.text}`;
      }).join('\n');
    if (entries.length > 30) {
      entrySummary += `\n... and ${entries.length - 30} more entries.`;
    }
  }

  return `You are a knowledgeable, friendly gardening assistant. The user has a 1,200 sq ft garden in Washington, DC (USDA Zone 7b/8a). Today is ${today}.

Current month planting guide for Zone 7b/8a:
- Start indoors: ${monthData.indoors.join(', ') || 'nothing this month'}
- Direct sow: ${monthData.sow.join(', ') || 'nothing this month'}
- Transplant: ${monthData.transplant.join(', ') || 'nothing this month'}
- Harvest: ${monthData.harvest.join(', ') || 'nothing this month'}
- Tasks: ${monthData.tasks.join('; ')}
${entrySummary}

Guidelines:
- Give specific, actionable advice based on their zone, location, and actual garden observations.
- Reference their journal entries when relevant (e.g., "I see you noted aphids last week...").
- Keep answers concise but thorough. Use bullet points for lists.
- If they mention a problem, help diagnose it and suggest organic/integrated solutions first.
- Be warm and encouraging.`;
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;

  const apiKey = getApiKey();
  if (!apiKey) { showToast('Please set your API key first'); return; }

  // Capture photo if attached
  const attachedPhoto = chatPhotoData;
  chatPhotoData = null;
  document.getElementById('chatPhotoPreview').innerHTML = '';

  // Hide suggestions after first message
  const suggestions = document.getElementById('chatSuggestions');
  if (suggestions) suggestions.remove();

  input.value = '';
  const messagesEl = document.getElementById('chatMessages');

  // Add user message
  const userDiv = document.createElement('div');
  userDiv.className = 'chat-msg user';
  const photoInMsg = attachedPhoto ? `<div class="chat-photo-preview"><img src="${attachedPhoto}"></div>` : '';
  userDiv.innerHTML = `<div class="chat-bubble">${photoInMsg}${escapeHtml(msg)}</div>`;
  messagesEl.appendChild(userDiv);

  // Add typing indicator
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-msg assistant';
  typingDiv.innerHTML = `<div class="chat-bubble chat-typing"><span></span><span></span><span></span></div>`;
  messagesEl.appendChild(typingDiv);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // Build messages for API  with image if attached
  let userContent;
  if (attachedPhoto) {
    const base64Data = attachedPhoto.replace(/^data:image\/\w+;base64,/, '');
    userContent = [
      { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: base64Data } },
      { type: 'text', text: msg }
    ];
  } else {
    userContent = msg;
  }
  chatHistory.push({ role: 'user', content: userContent });

  const sendBtn = document.getElementById('chatSend');
  sendBtn.disabled = true;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 1024,
        system: buildSystemPrompt(),
        messages: chatHistory.slice(-20) // keep last 20 messages for context
      })
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || `API error ${response.status}`);
    }

    const data = await response.json();
    const reply = data.content[0].text;
    chatHistory.push({ role: 'assistant', content: reply });

    // Remove typing indicator
    typingDiv.remove();

    // Add assistant message
    const assistantDiv = document.createElement('div');
    assistantDiv.className = 'chat-msg assistant';
    assistantDiv.innerHTML = `<div class="chat-bubble">${formatMarkdown(reply)}</div>`;
    messagesEl.appendChild(assistantDiv);

  } catch (err) {
    typingDiv.remove();
    const errDiv = document.createElement('div');
    errDiv.className = 'chat-msg assistant';
    errDiv.innerHTML = `<div class="chat-bubble" style="color:var(--red)">Error: ${escapeHtml(err.message)}</div>`;
    messagesEl.appendChild(errDiv);
    chatHistory.pop(); // remove the failed user message from history
  }

  sendBtn.disabled = false;
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function formatMarkdown(text) {
  // Simple markdown: bold, bullets, paragraphs
  return text
    .split('\n\n').map(para => {
      // Check if it's a bullet list
      const lines = para.split('\n');
      const isList = lines.every(l => l.match(/^[-*]\s/) || l.trim() === '');
      if (isList && lines.some(l => l.match(/^[-*]\s/))) {
        const items = lines.filter(l => l.match(/^[-*]\s/))
          .map(l => `<li>${formatInline(l.replace(/^[-*]\s/, ''))}</li>`).join('');
        return `<ul>${items}</ul>`;
      }
      // Check numbered list
      const isOl = lines.every(l => l.match(/^\d+\.\s/) || l.trim() === '');
      if (isOl && lines.some(l => l.match(/^\d+\.\s/))) {
        const items = lines.filter(l => l.match(/^\d+\.\s/))
          .map(l => `<li>${formatInline(l.replace(/^\d+\.\s/, ''))}</li>`).join('');
        return `<ol>${items}</ol>`;
      }
      return `<p>${formatInline(para.replace(/\n/g, '<br>'))}</p>`;
    }).join('');
}

function formatInline(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code>$1</code>');
}

// ===================== SETTINGS PAGE =====================
function renderSettings() {
  const entries = loadEntries();
  document.getElementById('entryCountDisplay').innerHTML =
    `<strong>${entries.length}</strong>observation${entries.length !== 1 ? 's' : ''} recorded`;
  document.getElementById('settingsApiKey').value = getApiKey();
}

document.getElementById('settingsSaveKey').addEventListener('click', () => {
  const key = document.getElementById('settingsApiKey').value.trim();
  if (!key) { showToast('Please enter a key'); return; }
  setApiKey(key);
  showToast('API key saved!');
});
document.getElementById('settingsClearKey').addEventListener('click', () => {
  clearApiKey();
  document.getElementById('settingsApiKey').value = '';
  showToast('API key removed');
});

document.getElementById('exportBtn').addEventListener('click', () => {
  const entries = loadEntries();
  const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `garden-journal-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Data exported!');
});

document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const imported = JSON.parse(reader.result);
      if (!Array.isArray(imported)) throw new Error();
      const existing = loadEntries();
      const existingIds = new Set(existing.map(e => e.id));
      const newEntries = imported.filter(e => e.id && e.text && !existingIds.has(e.id));
      saveEntries([...existing, ...newEntries]);
      showToast(`Imported ${newEntries.length} new entries`);
      renderSettings();
      renderJournal();
    } catch { showToast('Invalid file format'); }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('emailBtn').addEventListener('click', () => {
  const entries = loadEntries();
  const cats = {};
  entries.forEach(e => {
    const c = (CATEGORIES[e.category] || CATEGORIES.general).label;
    cats[c] = (cats[c] || 0) + 1;
  });
  const summary = Object.entries(cats).map(([k, v]) => `  ${k}: ${v}`).join('\n');
  const latest = entries.sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 5)
    .map(e => `  [${new Date(e.date).toLocaleDateString()}] ${e.text.slice(0, 80)}...`)
    .join('\n');
  const body = encodeURIComponent(
    `Garden Journal Backup Summary\nDate: ${new Date().toLocaleDateString()}\nTotal entries: ${entries.length}\n\nBy category:\n${summary}\n\nLatest entries:\n${latest}\n\n(Export full data as JSON from the app for complete backup)`
  );
  window.location.href = `mailto:?subject=${encodeURIComponent('Garden Journal Backup - ' + new Date().toLocaleDateString())}&body=${body}`;
});

document.getElementById('clearBtn').addEventListener('click', () => {
  showConfirm('Delete ALL journal data? This cannot be undone.', () => {
    localStorage.removeItem(STORAGE_KEY);
    renderSettings();
    renderJournal();
    showToast('All data deleted');
  });
});

// ===================== INIT =====================
renderJournal();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
